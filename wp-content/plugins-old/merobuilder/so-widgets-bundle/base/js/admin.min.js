
(function($){$.fn.sowSetupForm=function(){return $(this).each(function(i,el){var $el=$(el);if($el.is('.siteorigin-widget-form-main')){if($el.data('sow-form-setup')==true)return true;if($('body').hasClass('widgets-php')&&!$el.is(':visible'))return true;$el.sowSetupPreview();}
var $fields=$el.find('> .siteorigin-widget-field');$fields.find('> .siteorigin-widget-section').sowSetupForm();$fields.find('.siteorigin-widget-input').each(function(i,input){if($(input).data('original-name')==null){$(input).data('original-name',$(input).attr('name'));}});$fields.find('> .siteorigin-widget-field-repeater').sowSetupRepeater();$el.find('.siteorigin-widget-field-repeater-item').sowSetupRepeaterActions();$fields.find('> .siteorigin-widget-input-color').wpColorPicker().closest('.siteorigin-widget-field').find('a').click(function(){if(typeof $.fn.dialog!='undefined'){$(this).closest('.panel-dialog').dialog("option","position","center");}});$fields.find('> .media-field-wrapper').each(function(){var $media=$(this);$media.find('a.media-upload-button').click(function(event){if(typeof wp.media=='undefined')return;var $$=$(this);var $c=$(this).closest('.siteorigin-widget-field');var frame=$(this).data('frame');if(frame){frame.open();return false;}
frame=wp.media({title:$$.data('choose'),library:{type:$$.data('library').split(',').map(function(v){return v.trim()})},button:{text:$$.data('update'),close:false}});$$.data('frame',frame);frame.on('select',function(){var attachment=frame.state().get('selection').first().attributes;$c.find('.current .title').html(attachment.title);$c.find('input[type=hidden]').val(attachment.id);if(typeof attachment.sizes!='undefined'){if(typeof attachment.sizes.thumbnail!='undefined')
$c.find('.current .thumbnail').attr('src',attachment.sizes.thumbnail.url).fadeIn();else
$c.find('.current .thumbnail').attr('src',attachment.sizes.full.url).fadeIn();}
else{$c.find('.current .thumbnail').attr('src',attachment.icon).fadeIn();}
frame.close();});frame.open();return false;});$media.mouseenter(function(){if($(this).closest('.siteorigin-widget-field').find('input[type=hidden]').val()!='')$(this).find('.media-remove-button').fadeIn('fast');}).mouseleave(function(){$(this).find('.media-remove-button').fadeOut('fast');})
$media.find('.current').mouseenter(function(){var t=$(this).find('.title');if(t.html()!=''){t.fadeIn('fast');}}).mouseleave(function(){$(this).find('.title').clearQueue().fadeOut('fast');})
$media.find('a.media-remove-button').click(function(){var $$=$(this).closest('.siteorigin-widget-field');$$.find('.current .title').html('');$$.find('input[type=hidden]').val('');$$.find('.current .thumbnail').fadeOut('fast');$(this).fadeOut('fast');});})
$fields.filter('.siteorigin-widget-field-type-widget, .siteorigin-widget-field-type-section').find('> label').click(function(){var $$=$(this);$(this).toggleClass('siteorigin-widget-section-visible');$(this).siblings('.siteorigin-widget-section').slideToggle(function(){if(typeof $.fn.dialog!='undefined'){$(this).closest('.panel-dialog').dialog("option","position","center");}});});var iconWidgetCache={};$fields.find('> .siteorigin-widget-icon-selector').each(function(){var $is=$(this);var $v=$is.find('.siteorigin-widget-icon-icon');var rerenderIcons=function(){var family=$is.find('select.siteorigin-widget-icon-family').val();var container=$is.find('.siteorigin-widget-icon-icons');if(typeof iconWidgetCache[family]=='undefined')return;container.empty();if($('#'+'siteorigin-widget-font-'+family).length==0){$("<link rel='stylesheet' type='text/css'>").attr('id','siteorigin-widget-font-'+family).attr('href',iconWidgetCache[family]['style_uri']).appendTo('head');}
for(var i in iconWidgetCache[family]['icons']){var icon=$('<div data-sow-icon="'+iconWidgetCache[family]['icons'][i]+'"/>').attr('data-value',family+'-'+i).addClass('sow-icon-'+family).addClass('siteorigin-widget-icon-icons-icon').click(function(){var $$=$(this);if($$.hasClass('siteorigin-widget-active')){$$.removeClass('siteorigin-widget-active');$v.val('');}
else{container.find('.siteorigin-widget-icon-icons-icon').removeClass('siteorigin-widget-active');$$.addClass('siteorigin-widget-active');$v.val($(this).data('value'));}});if($v.val()==family+'-'+i)icon.addClass('siteorigin-widget-active');container.append(icon);}
container.prepend(container.find('.siteorigin-widget-active'));}
var changeIconFamily=function(){var family=$is.find('select.siteorigin-widget-icon-family').val();if(typeof family=='undefined'||family=='')return;if(typeof iconWidgetCache[family]=='undefined'){$.getJSON(ajaxurl,{'action':'siteorigin_widgets_get_icons','family':$is.find('select.siteorigin-widget-icon-family').val()},function(data){iconWidgetCache[family]=data;rerenderIcons()});}
else{rerenderIcons();}}
changeIconFamily();$is.find('select.siteorigin-widget-icon-family').change(function(){$is.find('.siteorigin-widget-icon-icons').empty();changeIconFamily();});});$el.trigger('sowsetupform').data('sow-form-setup',true);$el.find('.siteorigin-widget-field-repeater-item').trigger('updateFieldPositions');});};$.fn.sowSetupPreview=function(){var $el=$(this);var previewButton=$el.siblings('.siteorigin-widget-preview');previewButton.find('> a').click(function(e){e.preventDefault();var data={};$el.find('*[name]').each(function(){var $$=$(this);var name=/[a-zA-Z\-]+\[[0-9]+\]\[(.*)\]/.exec($$.attr('name'));name=name[1];parts=name.split('][');parts=parts.map(function(e){if(!isNaN(parseFloat(e))&&isFinite(e))return parseInt(e);else return e;});var sub=data;for(var i=0;i<parts.length;i++){if(i==parts.length-1){if($$.attr('type')=='checkbox'){if($$.is(':checked'))sub[parts[i]]=$$.val()!=''?$$.val():true;}
else sub[parts[i]]=$$.val();}
else{if(typeof sub[parts[i]]=='undefined'){sub[parts[i]]={};}
sub=sub[parts[i]];}}});var overlay=$('<div class="siteorigin-widgets-preview-modal-overlay"></div>').appendTo('body');var modal=$('<div class="siteorigin-widgets-preview-modal"></div>').appendTo('body');var close=$('<div class="siteorigin-widgets-preview-close dashicons dashicons-no"></div>').appendTo(modal);var iframe=$('<iframe class="siteorigin-widgets-preview-iframe" scrolling="no"></iframe>').appendTo(modal);$.post(ajaxurl,{'action':'so_widgets_preview','data':JSON.stringify(data),'class':$el.data('class')},function(html){iframe.contents().find('body').html(html);});close.add(overlay).click(function(){overlay.remove();modal.remove();});});}
$.fn.sowSetupRepeater=function(){return $(this).each(function(i,el){var $el=$(el);var $items=$el.find('.siteorigin-widget-field-repeater-items');var name=$el.data('repeater-name');$items.bind('updateFieldPositions',function(){var $$=$(this);$$.find('> .siteorigin-widget-field-repeater-item').each(function(i,el){$(el).find('.siteorigin-widget-input').each(function(j,input){var pos=$(input).data('repeater-positions');if(typeof pos=='undefined'){pos={};}
pos[name]=i;$(input).data('repeater-positions',pos);});});$$.find('.siteorigin-widget-input').each(function(i,input){var pos=$(input).data('repeater-positions');var $in=$(input);if(typeof pos!='undefined'){var newName=$in.data('original-name');if(typeof newName=='undefined'){$in.data('original-name',$in.attr('name'));newName=$in.attr('name');}
for(var k in pos){newName=newName.replace('#'+k+'#',pos[k]);}
$(input).attr('name',newName);}});});$items.sortable({handle:'.siteorigin-widget-field-repeater-item-top',items:'> .siteorigin-widget-field-repeater-item',update:function(){$items.trigger('updateFieldPositions');}});$items.trigger('updateFieldPositions');$el.find('> .siteorigin-widget-field-repeater-add').disableSelection().click(function(e){e.preventDefault();$el.closest('.siteorigin-widget-field-repeater').sowAddRepeaterItem().find('> .siteorigin-widget-field-repeater-items').slideDown('fast');if(typeof $.fn.dialog!='undefined'){$(this).closest('.panel-dialog').dialog("option","position","center");}});$el.find('> .siteorigin-widget-field-repeater-top > .siteorigin-widget-field-repeater-expend').click(function(e){e.preventDefault();$el.closest('.siteorigin-widget-field-repeater').find('> .siteorigin-widget-field-repeater-items').slideToggle('fast');});});};$.fn.sowAddRepeaterItem=function(){return $(this).each(function(i,el){var $el=$(el);var theClass=$el.closest('.siteorigin-widget-form').data('class');var formClass=$el.closest('.siteorigin-widget-form').data('class');var item=$('<div class="siteorigin-widget-field-repeater-item" />').append($('<div class="siteorigin-widget-field-repeater-item-top" />').append($('<div class="siteorigin-widget-field-expand" />')).append($('<div class="siteorigin-widget-field-remove" />')).append($('<h4 />').html($el.data('item-name')))).append($('<div class="siteorigin-widget-field-repeater-item-form" />').html(window.sow_repeater_html[formClass][$el.data('repeater-name')])).sowSetupRepeaterActions();$el.find('> .siteorigin-widget-field-repeater-items').append(item).sortable("refresh").trigger('updateFieldPositions');item.hide().slideDown('fast');});};$.fn.sowSetupRepeaterActions=function(){return $(this).each(function(i,el){var $el=$(el);if(typeof $el.data('sowrepeater-actions-setup')=='undefined'){var top=$el.find('> .siteorigin-widget-field-repeater-item-top');top.find('.siteorigin-widget-field-expand').click(function(e){e.preventDefault();$(this).closest('.siteorigin-widget-field-repeater-item').find('.siteorigin-widget-field-repeater-item-form').eq(0).slideToggle('fast',function(){if(typeof $.fn.dialog!='undefined'){$(this).closest('.panel-dialog').dialog("option","position","center");}});});top.find('.siteorigin-widget-field-remove').click(function(e){e.preventDefault();if(confirm(soWidgets.sure)){var $s=$(this).closest('.siteorigin-widget-field-repeater-items');$(this).closest('.siteorigin-widget-field-repeater-item').slideUp('fast',function(){$(this).remove();$s.sortable("refresh").trigger('updateFieldPositions');});}});$el.find('> .siteorigin-widget-field-repeater-item-form').sowSetupForm();$el.data('sowrepeater-actions-setup',true);}});}
$('.widgets-holder-wrap').on('click','.widget:has(.siteorigin-widget-form-main) .widget-top',function(){var $$=$(this).closest('.widget').find('.siteorigin-widget-form-main');setTimeout(function(){$$.sowSetupForm();},200);});$(document).on('dialogopen',function(e){$(e.target).find('.siteorigin-widget-form-main').sowSetupForm();});})(jQuery);